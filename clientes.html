<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGM-IF | Clientes</title>
    <link rel="stylesheet" href="style.css"> 
<script>
    // Código revisado com proteções e logs para facilitar depuração
    let clientesData = [];
    const STORAGE_KEY = 'sigm-if_clientes';
    const COUNTER_KEY = 'sigm-if_clientes_id_counter';
    let linhaSelecionada = null; 

    // Use DOMContentLoaded para garantir que o DOM exista
    document.addEventListener('DOMContentLoaded', loadData);

    // --- Gerenciamento de ID Auto-Incrementado ---
    function getNextId() {
        let counter = parseInt(localStorage.getItem(COUNTER_KEY) || '100', 10);
        if (!Number.isFinite(counter)) counter = 100;
        counter++;
        localStorage.setItem(COUNTER_KEY, counter.toString());
        return 'CLI-' + counter.toString().padStart(3, '0');
    }

    // --- Funções de Persistência e Carga ---
    function saveData() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(clientesData));
        } catch (e) {
            console.error('Erro ao salvar dados no localStorage:', e);
            alert('Erro ao salvar dados localmente. Veja o console para mais detalhes.');
        }
    }

    function loadData() {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
            try {
                const parsed = JSON.parse(storedData);
                clientesData = Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                console.error('Dados inválidos em localStorage (sigm-if_clientes). Limpando e iniciando vazio.', e);
                clientesData = [];
                localStorage.removeItem(STORAGE_KEY);
            }
        } else {
            clientesData = [];
        }

        // Atualiza o contador com base no maior ID existente para evitar conflitos
        if (clientesData.length > 0) {
            const maxId = clientesData.reduce((max, item) => {
                if (!item || typeof item.codigo !== 'string') return max;
                const parts = item.codigo.split('-');
                const num = parseInt(parts[1], 10);
                return (Number.isFinite(num) && num > max) ? num : max;
            }, 100);
            localStorage.setItem(COUNTER_KEY, maxId.toString());
        }

        drawTable(clientesData);
        console.log('Dados carregados:', clientesData);
    }

    // --- Funções de Controle de Formulário ---
    function openForm() {
        const form = document.getElementById('form-cadastro');
        const formElement = document.getElementById('cadastro-form-cliente');

        form.style.display = 'block';

        const editIndex = formElement.getAttribute('data-edit-index');
        if (editIndex == null) { // cobre null e undefined
            document.getElementById('cli-codigo-leitura').value = 'NOVO (Gerado ao Salvar)';
        }
    }

    function closeForm() {
        const form = document.getElementById('form-cadastro');
        const formElement = document.getElementById('cadastro-form-cliente');

        form.style.display = 'none';
        formElement.reset();
        formElement.removeAttribute('data-edit-index');
        document.querySelectorAll('.data-table tbody tr').forEach(row => row.classList.remove('selecionada'));
        linhaSelecionada = null;
    }

    // --- Funções de CRUD ---
    function salvarCliente() {
        const form = document.getElementById('form-cadastro');
        if (form.style.display === 'none') {
            alert("Por favor, abra o formulário antes de Salvar.");
            return;
        }

        const nome = document.getElementById('cli-nome').value.trim();
        const tipo = document.getElementById('cli-tipo').value.trim();
        const cpf = document.getElementById('cli-cpf').value.trim();
        const email = document.getElementById('cli-email').value.trim();
        const telefone = document.getElementById('cli-telefone').value.trim();
        const endereco = document.getElementById('cli-endereco').value.trim();

        if (!nome || !tipo || !cpf ) {
            alert("Preencha todos os campos obrigatórios (marcados com *)!");
            return;
        }

        let codigo;
        const formElement = document.getElementById('cadastro-form-cliente');
        const editIndex = formElement.getAttribute('data-edit-index');

        if (editIndex != null) {
            // EDIÇÃO: Mantém o código existente (editIndex é string)
            const idx = parseInt(editIndex, 10);
            if (!Number.isFinite(idx) || !clientesData[idx]) {
                alert('Índice de edição inválido. Recarregue a página e tente novamente.');
                return;
            }
            codigo = clientesData[idx].codigo;
        } else {
            // NOVO: Gera um novo código auto-incrementado
            codigo = getNextId();
        }

        const novoCliente = { codigo, nome, tipo, cpf, email, telefone, endereco };

        if (editIndex != null) {
            const idx = parseInt(editIndex, 10);
            clientesData[idx] = novoCliente;
            alert(`Cliente ${nome} (Cód: ${codigo}) editado com sucesso.`);
        } else {
            clientesData.push(novoCliente);
            alert(`Cliente ${nome} (Cód: ${codigo}) salvo com sucesso!`);
        }

        saveData();
        drawTable(clientesData);
        closeForm();
    }
    
    function drawTable(data) {
        try {
            const tabelaCorpo = document.querySelector('.data-table tbody');
            tabelaCorpo.innerHTML = '';

            data.forEach((item) => {
                const linha = tabelaCorpo.insertRow();
                linha.setAttribute('data-codigo', item.codigo || '');
                linha.onclick = function() { selecionarLinha(linha); };

                const dadosLinha = [
                    item.nome || '', item.tipo || '', item.codigo || '', item.cpf || '', item.email || '',
                    item.telefone || '', item.endereco || ''
                ];

                const headers = ['Nome', 'Tipo', 'Código', 'CPF', 'E-mail', 'Telefone', 'Endereço'];

                dadosLinha.forEach((dado, cellIndex) => {
                    const celula = linha.insertCell(cellIndex);
                    celula.setAttribute('data-label', headers[cellIndex]);
                    celula.innerHTML = dado;
                });
            });
            linhaSelecionada = null;
        } catch (e) {
            console.error('Erro ao desenhar a tabela:', e);
        }
    }

    function selecionarLinha(linha) {
        document.querySelectorAll('.data-table tbody tr').forEach(row => {
            row.classList.remove('selecionada');
        });
        linha.classList.add('selecionada');
        linhaSelecionada = linha;
    }

    function excluirLinha() {
        if (!linhaSelecionada) {
            alert("Selecione um cliente na lista para poder excluir.");
            return;
        }

        const codigoCliente = linhaSelecionada.getAttribute('data-codigo') || '';

        if (confirm("Tem certeza que deseja excluir o cliente com Código " + codigoCliente + "?")) {
            const indexParaExcluir = clientesData.findIndex(c => c && c.codigo === codigoCliente);
            if (indexParaExcluir !== -1) {
                clientesData.splice(indexParaExcluir, 1);
                saveData();
                drawTable(clientesData);
                alert("Cliente excluído com sucesso.");
            } else {
                alert("Erro: Cliente não encontrado na base de dados.");
            }
            linhaSelecionada = null;
        }
    }

    function editarLinha() {
        if (!linhaSelecionada) {
            alert("Selecione um cliente na lista para poder editar.");
            return;
        }

        openForm();

        const formElement = document.getElementById('cadastro-form-cliente');
        const codigoCliente = linhaSelecionada.getAttribute('data-codigo') || '';
        const index = clientesData.findIndex(c => c && c.codigo === codigoCliente);

        if (index === -1) {
            alert("Erro: Cliente não encontrado para edição.");
            closeForm();
            return;
        }

        const item = clientesData[index];

        document.getElementById('cli-nome').value = item.nome || '';
        document.getElementById('cli-tipo').value = item.tipo || '';
        document.getElementById('cli-codigo-leitura').value = item.codigo || '';
        document.getElementById('cli-cpf').value = item.cpf || '';
        document.getElementById('cli-email').value = item.email || '';
        document.getElementById('cli-telefone').value = item.telefone || '';
        document.getElementById('cli-endereco').value = item.endereco || '';

        formElement.setAttribute('data-edit-index', index.toString());
    }
    
    function pesquisarClientes() {
        const termo = (document.getElementById('search-clientes').value || '').toUpperCase().trim();
        if (termo === '') {
            drawTable(clientesData);
            return;
        }

        const resultados = clientesData.filter(cliente => {
            if (!cliente) return false;
            return (cliente.nome || '').toUpperCase().includes(termo) ||
                   (cliente.codigo || '').toUpperCase().includes(termo) ||
                   (cliente.cpf || '').toUpperCase().includes(termo);
        });
        drawTable(resultados);
    }

    function voltarParaHome() {
        const perfil = localStorage.getItem('sigm-if_perfil');

        if (perfil === 'ADMIN') {
            window.location.href = 'telaInicialADMIN.html';
        } else if (perfil === 'MEMBRO') {
            window.location.href = 'telainicialMEM.html';
        } else {
            alert("Sessão não identificada. Redirecionando para o login.");
            window.location.href = 'login.html';
        }
    }
</script>
<style>
    .data-table tbody tr.selecionada {
        background-color: #7bff6a !important;
        border: 2px solid #1de203;
    }
</style>
</head>
<body>
    <header class="header">
        <img src="IFPB.png" alt="Logotipo Instito Federal da Paraíba" class="login-logo">
        <h1>Sistema de Gestão de Manutenção de Equipamentos</h1>
        <p>SIGM-IF - Cadastro de Clientes</p>
    </header>

    <main class="content-container">
        <h2>Gerenciamento de Clientes</h2>
        
        <div class="search-container">
            <input type="text" id="search-clientes" placeholder="Buscar Cliente (Nome, Código ou CPF)">
            <button class="btn-acao" onclick="pesquisarClientes()">Buscar Cliente</button>
        </div>

        <table class="data-table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Tipo</th>
                    <th>Código</th>
                    <th>CPF</th>
                    <th>E-mail</th>
                    <th>Telefone</th> 
                    <th>Endereço</th> 
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

        <div id="form-cadastro" style="display:none; padding: 20px; background-color: white; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px var(--cor-sombra);">
            <h3>Dados do Cliente (Novo/Editar)</h3>
            <form id="cadastro-form-cliente" onsubmit="return false;">
                <div class="form-grid">
                    <div class="form-group"><label>Código *</label><input type="text" id="cli-codigo-leitura" readonly></div>
                    <div class="form-group"><label>Nome Completo *</label><input type="text" id="cli-nome" required></div>
                    <div class="form-group"><label>Tipo de Cliente *</label>
                        <select id="cli-tipo" required>
                            <option>Aluno</option><option>Professor</option><option>Funcionário</option>
                        </select>
                    </div>
                    <div class="form-group"><label>CPF *</label><input type="text" id="cli-cpf" required></div>
                    <div class="form-group"><label>E-Mail</label><input type="email" id="cli-email"></div>
                    <div class="form-group"><label>Telefone</label><input type="text" id="cli-telefone" ></div> 
                    <div class="form-group"><label>Endereço</label><input type="text" id="cli-endereco" ></div> 
                </div>
                <div style="margin-top: 20px;">
                    <button type="button" class="btn-acao" onclick="salvarCliente()" style="background-color: #28a745;">Salvar</button>
                    <button type="button" class="btn-acao" onclick="closeForm()" style="background-color: #dc3545;">Cancelar</button>        
                </div>
            </form>
        </div>

       <div class="action-buttons">
            <button class="btn-acao" onclick="openForm()">Novo Cliente</button>
            <button class="btn-acao" onclick="editarLinha()">Editar</button>
            <button class="btn-acao" onclick="excluirLinha()">Excluir</button>
            <button class="btn-acao" onclick="voltarParaHome()">Voltar</button>
        </div>

    </main>

    <footer class="footer">
        <p>&copy; 2025 Equipe SIGM-IF</p>
    </footer>
</body>
</html>
