<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIGM-IF | Clientes</title>
    <link rel="stylesheet" href="style.css"> 
<script>
    let clientesData = [];
    const STORAGE_KEY = 'sigm-if_clientes';
    const COUNTER_KEY = 'sigm-if_clientes_id_counter'; // Chave para o contador de ID
    let linhaSelecionada = null; 

    window.onload = loadData;

    // --- Gerenciamento de ID Auto-Incrementado ---
    function getNextId() {
        // Carrega o contador atual (inicia em 100 se não existir)
        let counter = parseInt(localStorage.getItem(COUNTER_KEY) || '100'); 
        counter++;
        localStorage.setItem(COUNTER_KEY, counter.toString());
        return 'CLI-' + counter.toString().padStart(3, '0');
    }

    // --- Funções de Persistência e Carga ---
    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(clientesData));
    }

    function loadData() {
        const storedData = localStorage.getItem(STORAGE_KEY);
        if (storedData) {
            clientesData = JSON.parse(storedData);
        } else {
            clientesData = [];
        }
        
        // Atualiza o contador com base no maior ID existente para evitar conflitos
        if (clientesData.length > 0) {
            const maxId = clientesData.reduce((max, item) => {
                // Pega o número após 'CLI-'
                const num = parseInt(item.codigo.split('-')[1] || '0');
                return num > max ? num : max;
            }, 0);
            localStorage.setItem(COUNTER_KEY, maxId.toString());
        }

        drawTable(clientesData);
    }

    // --- Funções de Formulário e CRUD ---
    function toggleForm() {
        const form = document.getElementById('form-cadastro');
        const formElement = document.getElementById('cadastro-form-cliente');
        
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
        
        if (form.style.display === 'block' && formElement.getAttribute('data-edit-index') === null) {
            document.getElementById('cli-codigo-leitura').value = 'NOVO (Gerado ao Salvar)';
        }
        
        if (form.style.display === 'none') {
            formElement.reset();
            formElement.removeAttribute('data-edit-index');
            document.querySelectorAll('.data-table tbody tr').forEach(row => row.classList.remove('selecionada'));
            linhaSelecionada = null;
        }
    }

    function salvarCliente() {
        const form = document.getElementById('form-cadastro');
        if (form.style.display === 'none') {
            alert("Por favor, abra o formulário antes de Salvar.");
            return;
        }

        // Campos obrigatórios (de acordo com a última solicitação)
        const nome = document.getElementById('cli-nome').value;
        const tipo = document.getElementById('cli-tipo').value;
        const cpf = document.getElementById('cli-cpf').value;

        // Campos opcionais/adicionais
        const email = document.getElementById('cli-email').value;
        const telefone = document.getElementById('cli-telefone').value; // CAMPO NOVO
        const endereco = document.getElementById('cli-endereco').value; // CAMPO NOVO
        
        if (!nome || !tipo || !cpf ) {
            alert("Preencha todos os campos obrigatórios (marcados com *)!");
            return;
        }

        let codigo;
        const formElement = document.getElementById('cadastro-form-cliente');
        const editIndex = formElement.getAttribute('data-edit-index');

        if (editIndex !== null) {
            // EDIÇÃO: Mantém o código existente
            codigo = clientesData[parseInt(editIndex)].codigo;
        } else {
            // NOVO: Gera um novo código auto-incrementado
            codigo = getNextId();
        }

        const novoCliente = { 
            codigo, nome, tipo, cpf, email, telefone, endereco
        };

        if (editIndex !== null) {
            // EDIÇÃO
            clientesData[parseInt(editIndex)] = novoCliente;
            alert(`Cliente ${nome} (Cód: ${codigo}) editado com sucesso.`);
            formElement.removeAttribute('data-edit-index');
        } else {
            // NOVO
            clientesData.push(novoCliente);
            alert(`Cliente ${nome} (Cód: ${codigo}) salvo com sucesso!`);
        }

        saveData();
        drawTable(clientesData);
        formElement.reset(); 
        toggleForm(); 
    }
    
    function drawTable(data) {
        const tabelaCorpo = document.querySelector('.data-table tbody');
        tabelaCorpo.innerHTML = ''; 

        data.forEach((item, index) => {
            const linha = tabelaCorpo.insertRow();
            // É importante usar clientesData.indexOf(item) para garantir o index correto após a filtragem
            linha.setAttribute('data-index', clientesData.indexOf(item)); 
            linha.onclick = function() { selecionarLinha(linha, clientesData.indexOf(item)); };

            // INCLUÍNDO TELEFONE E ENDEREÇO NA VISUALIZAÇÃO DA TABELA
            const dadosLinha = [
                item.nome, item.tipo, item.codigo, item.cpf, item.email, 
                item.telefone, item.endereco
            ];

            const headers = ['Nome', 'Tipo', 'Código', 'CPF', 'E-mail', 'Telefone', 'Endereço'];

            dadosLinha.forEach((dado, cellIndex) => {
                const celula = linha.insertCell(cellIndex);
                celula.setAttribute('data-label', headers[cellIndex]); 
                celula.innerHTML = dado;
            });
        });
        linhaSelecionada = null; 
    }

    function selecionarLinha(linha, index) {
        document.querySelectorAll('.data-table tbody tr').forEach(row => {
            row.classList.remove('selecionada');
        });
        linha.classList.add('selecionada');
        linhaSelecionada = linha;
        linhaSelecionada.dataIndex = parseInt(linha.getAttribute('data-index')); 
    }

    function excluirLinha() {
        if (!linhaSelecionada) {
            alert("Selecione um cliente na lista para poder excluir.");
            return;
        }
        if (confirm("Tem certeza que deseja excluir este cliente?")) {
            // O splice usa o dataIndex (índice na lista completa)
            clientesData.splice(linhaSelecionada.dataIndex, 1);
            
            saveData(); 
            drawTable(clientesData);
            alert("Cliente excluído com sucesso.");
        }
    }

    function editarLinha() {
        if (!linhaSelecionada) {
            alert("Selecione um cliente na lista para poder editar.");
            return;
        }
        toggleForm();

        const index = linhaSelecionada.dataIndex;
        const item = clientesData[index];

        document.getElementById('cli-nome').value = item.nome;
        document.getElementById('cli-tipo').value = item.tipo;
        document.getElementById('cli-codigo-leitura').value = item.codigo; // Código lido
        document.getElementById('cli-cpf').value = item.cpf;
        document.getElementById('cli-email').value = item.email;
        document.getElementById('cli-endereco').value = item.endereco; // NOVO CAMPO

        document.getElementById('cadastro-form-cliente').setAttribute('data-edit-index', index);
    }
    
    function pesquisarClientes() {
        const termo = document.getElementById('search-clientes').value.toUpperCase().trim();
        if (termo === '') {
            drawTable(clientesData);
            return;
        }

        const resultados = clientesData.filter(cliente => {
            return cliente.nome.toUpperCase().includes(termo) || 
                   cliente.codigo.toUpperCase().includes(termo) || 
                   cliente.cpf.toUpperCase().includes(termo);
        });
        drawTable(resultados);
    }

    // Adicionar em cada arquivo (clientes.html, equipamentos.html, etc.)
        function voltarParaHome() {
            // Tenta obter o perfil salvo no localStorage
            const perfil = localStorage.getItem('sigm-if_perfil');
            
            if (perfil === 'ADMIN') {
                window.location.href = 'telaInicialADMIN.html';
            } else if (perfil === 'MEMBRO') {
                window.location.href = 'telainicialMEM.html';
            } else {
                // Se o perfil não for encontrado (ex: usuário tentou entrar direto), redireciona para o login
                alert("Sessão expirada ou não identificada. Por favor, faça login novamente.");
                window.location.href = 'login.html'; 
            }
        }
</script>
<style>
    .data-table tbody tr.selecionada {
        background-color: #7bff6a !important; 
        border: 2px solid #1de203;
    }
</style>
</head>
<body>
    <header class="header">
        <img src="IFPB.png" alt="Logotipo Instito Federal da Paraíba" class="login-logo">
        <h1>Sistema de Gestão de Manutenção de Equipamentos</h1>
        <p>SIGM-IF - Cadastro de Clientes</p>
    </header>

    <main class="content-container">
        <h2>Gerenciamento de Clientes</h2>
        
        <div class="search-container">
            <input type="text" id="search-clientes" placeholder="Buscar Cliente (Nome, Código ou CPF)">
            <button class="btn-acao" onclick="pesquisarClientes()">Buscar Cliente</button>
        </div>

        <table class="data-table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Tipo</th>
                    <th>Código</th>
                    <th>CPF</th>
                    <th>E-mail</th>
                    <th>Telefone</th> <th>Endereço</th> </tr>
            </thead>
            <tbody>
                </tbody>
        </table>

        <div id="form-cadastro" style="display:none; padding: 20px; background-color: white; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px var(--cor-sombra);">
            <h3>Dados do Cliente (Novo/Editar)</h3>
            <form id="cadastro-form-cliente" class="form-grid">
                <div class="form-group"><label>Código *</label><input type="text" id="cli-codigo-leitura" readonly></div>
                <div class="form-group"><label>Nome Completo *</label><input type="text" id="cli-nome" required></div>
                <div class="form-group"><label>Tipo de Cliente *</label><select id="cli-tipo" required><option>Aluno</option><option>Professor</option><option>Funcionário</option></select></div>
                <div class="form-group"><label>CPF *</label><input type="text" id="cli-cpf" required></div>
                <div class="form-group"><label>E-Mail</label><input type="email" id="cli-email"></div>
                <div class="form-group"><label>Telefone</label><input type="text" id="cli-telefone" ></div> <div class="form-group"><label>Endereço</label><input type="text" id="cli-endereco" ></div> 
            <button class="btn-acao" onclick="salvarCliente()">Salvar</button>        
        </div>

       <div class="action-buttons">
            <button class="btn-acao" onclick="toggleForm()">Novo Cliente</button>
            <button class="btn-acao" onclick="editarLinha()">Editar</button>
            <button class="btn-acao" onclick="excluirLinha()">Excluir</button>
            <button class="btn-acao" onclick="voltarParaHome()">Voltar</button>
        </div>

    </main>

    <footer class="footer">
        <p>&copy; 2025 Equipe SIGM-IF</p>
    </footer>
</body>
</html>